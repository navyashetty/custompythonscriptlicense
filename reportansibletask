---

- name: Ensures custom dir exists
  file:
    path: '{{ report_remote_directory }}'
    state: directory

- name: Ensures output dir exists
  file:
    path: '{{ report_output_directory }}'
    state: directory

- name: Ensures python dir exists
  file:
    path: '{{ report_remote_directory }}/{{ report_jira_python_dir }}'
    state: directory

- name: install the latest version of python
  yum:
    name: '{{ report_jira_python_version }}'
    state: present

- name: copy credential files
  copy:
    content: |
      {{ license_information | to_json }}
    dest: '{{ report_remote_directory }}/.user.json'
    owner: root
    group: root
    mode: '0600'
    backup: true

- name: pip package requirement
  copy:
    content: |
      --index-url https://artifactory.wdc.com/artifactory/api/pypi/pypi-remote/simple
      numpy==1.18.4
      pandas==1.0.3
      pipreqs==0.4.10
      requests==2.23.0
      six==1.14.0
      urllib3==1.25.9
      click==7.1.2
      click-config-file==0.6.0
      mysql-connector-python==8.0.22
    dest: '{{ report_remote_directory }}/{{ report_jira_python_dir }}/requirements.txt'
    owner: root
    group: root
    mode: '0644'

- name: Setup venv for custom scripts
  pip:
    chdir: '{{ report_remote_directory }}/{{ report_jira_python_dir }}/'
    virtualenv: '{{ report_remote_directory }}/{{ report_jira_python_dir }}/venv'
    virtualenv_command: '/usr/bin/{{ report_jira_python_version }} -m venv'
    requirements: '{{ report_remote_directory }}/{{ report_jira_python_dir }}/requirements.txt'

- name: custom shell script copy to source
  template:
    src: 'jira/{{ item }}.j2'
    dest: '{{ report_remote_directory }}/{{ item }}'
    owner: root
    group: root
    mode: '0700'
  loop: '{{ report_jira_files }}'

- name: Creates a cron file under /etc/cron.d for jira_license.py
  cron:
    name: 'Run splunk report script in cron for: jira_license.py'
    special_time: daily
    user: root
    job: '{{ report_remote_directory }}/{{ report_jira_python_dir }}/venv/bin/python /opt/report/jira_license.py  -c {{ report_remote_directory  }}/.user.json -o {{ report_output_directory }}'  # noqa 204
    cron_file: 'jira_reporting'

- name: Creates a cron file under /etc/cron.d for jira_user.py
  cron:
    name: 'Run splunk report script in cron for: jira_user.py'
    special_time: daily
    user: root
    job: '{{ report_remote_directory }}/{{ report_jira_python_dir }}/venv/bin/python /opt/report/jira_user.py'
    cron_file: 'jira_reporting'

- name: disable cron file under /etc/cron.d for user details.sh
  cron:
    name: 'Run splunk report script in cron for: jira_users.sh'
    user: root
    state: absent
    cron_file: 'jira_reporting'
